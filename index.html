<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MArket - Gest√£o de Compras</title>
    
    <!-- Depend√™ncias CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              darkBg: '#121212',
              darkSurface: '#1e1e1e',
            },
            screens: {
              'xs': '375px',
            }
          }
        }
      }
    </script>

    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
      
      body { 
        font-family: 'Inter', sans-serif;
        -webkit-tap-highlight-color: transparent; 
        user-select: none; 
      }
      
      input, textarea { user-select: text; }
      
      .custom-scroll::-webkit-scrollbar { width: 4px; }
      .custom-scroll::-webkit-scrollbar-track { background: transparent; }
      .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      .dark .custom-scroll::-webkit-scrollbar-thumb { background: #334155; }
      
      @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(8px); } 
        to { opacity: 1; transform: translateY(0); } 
      }
      .animate-fadeIn { animation: fadeIn 0.25s ease-out forwards; }

      /* Ajuste para evitar que o conte√∫do fique atr√°s da navega√ß√£o fixa */
      .safe-bottom { padding-bottom: 180px; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react/": "https://esm.sh/react@^19.2.4/",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.4"
  }
}
</script>
</head>
<body class="bg-gray-50 dark:bg-darkBg text-gray-900 dark:text-gray-100 transition-colors duration-300 h-full overflow-hidden">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONSTANTES ---
        const DEFAULT_CATEGORIES = [
            { id: '1', name: 'Hortifruti', color: 'bg-green-500' },
            { id: '2', name: 'Carnes', color: 'bg-red-500' },
            { id: '3', name: 'Limpeza', color: 'bg-blue-500' },
            { id: '4', name: 'Padaria', color: 'bg-yellow-500' },
            { id: '5', name: 'Outros', color: 'bg-gray-500' },
        ];

        const COLOR_OPTIONS = [
            'bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 
            'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-gray-500',
            'bg-emerald-500', 'bg-amber-500', 'bg-sky-500', 'bg-rose-500'
        ];

        // --- COMPONENTES ---

        const Header = ({ theme, onToggleTheme }) => (
            <header className="bg-emerald-600 dark:bg-emerald-800 text-white p-4 shadow-md flex items-center justify-between sticky top-0 z-20 transition-colors duration-300">
                <div className="flex items-center gap-2">
                    <svg width="35" height="35" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" className="text-white">
                        <path d="M20 20H30L40 70H80L90 30H35" stroke="currentColor" strokeWidth="6" strokeLinecap="round" strokeLinejoin="round"/>
                        <circle cx="45" cy="85" r="7" fill="currentColor"/><circle cx="75" cy="85" r="7" fill="currentColor"/>
                        <text x="42" y="55" fontFamily="Arial" fontWeight="bold" fontSize="20" fill="currentColor">MA</text>
                    </svg>
                    <h1 className="text-2xl tracking-tighter">
                        <span className="font-black">MA</span><span className="font-light">rket</span>
                    </h1>
                </div>
                <button onClick={onToggleTheme} className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center transition-all active:scale-90 border border-white/10">
                    <i className={`fas ${theme === 'light' ? 'fa-moon' : 'fa-sun'} text-lg`}></i>
                </button>
            </header>
        );

        const Navigation = ({ currentView, setView, cartCount }) => {
            const navItems = [
                { id: 'LIST', icon: 'fa-list-ul', label: 'Faltas' },
                { id: 'CART', icon: 'fa-shopping-cart', label: 'Carrinho', badge: cartCount },
                { id: 'HISTORY', icon: 'fa-history', label: 'Hist√≥rico' },
                { id: 'CATEGORIES', icon: 'fa-tags', label: 'Categorias' },
            ];
            return (
                <nav className="fixed bottom-0 left-0 right-0 bg-white dark:bg-darkSurface border-t border-gray-100 dark:border-gray-800 flex justify-around items-center py-3 px-2 z-30 max-w-md mx-auto shadow-[0_-4px_16px_rgba(0,0,0,0.08)]">
                    {navItems.map((item) => (
                        <button key={item.id} onClick={() => setView(item.id)} className={`relative flex flex-col items-center gap-1 transition-all ${currentView === item.id ? 'text-emerald-600 dark:text-emerald-400 scale-110' : 'text-gray-400 dark:text-gray-500'}`}>
                            <i className={`fas ${item.icon} text-xl`}></i>
                            <span className="text-[10px] font-bold uppercase tracking-wider">{item.label}</span>
                            {item.badge > 0 && <span className="absolute -top-1 -right-2 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-black shadow-sm">{item.badge}</span>}
                        </button>
                    ))}
                </nav>
            );
        };

        const ShoppingListView = ({ items, categories, onToggle, onAdd, onRemove, getImportLink }) => {
            const [name, setName] = useState('');
            const [cat, setCat] = useState(categories[0]?.id || '');

            const share = () => {
                const link = getImportLink();
                let text = `*üõí Lista MArket:* ${items.map(i => i.name).join(', ')}%0A%0A`;
                const grouped = categories.map(c => ({ ...c, items: items.filter(i => i.categoryId === c.id) })).filter(g => g.items.length > 0);
                grouped.forEach(g => {
                    text += `*${g.name.toUpperCase()}*%0A`;
                    g.items.forEach(i => text += `- ${i.name}%0A`);
                    text += '%0A';
                });
                if (link) text += `‚ú® *Link para importar:*%0A${link}%0A%0A`;
                text += '--------------------%0Aüí° *DICA:* Para backup completo, use "Exportar Lista" nas Categorias.';
                window.open(`https://wa.me/?text=${text}`, '_blank');
            };

            const getCatColor = (c) => c.replace('bg-', 'bg-').replace('-500', '-500');

            return (
                <div className="space-y-6 animate-fadeIn safe-bottom">
                    <form onSubmit={(e) => { e.preventDefault(); if(name.trim()){ onAdd(name.trim(), cat); setName(''); } }} className="bg-white dark:bg-darkSurface p-4 rounded-3xl shadow-lg border border-gray-100 dark:border-gray-800 space-y-3">
                        <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="O que falta?" className="w-full p-4 bg-gray-50 dark:bg-darkBg rounded-2xl outline-none font-medium dark:text-white text-lg focus:ring-2 focus:ring-emerald-500/20 transition-all" />
                        <div className="flex gap-2">
                            <select value={cat} onChange={e => setCat(e.target.value)} className="flex-1 p-3 bg-gray-50 dark:bg-darkBg rounded-2xl font-bold dark:text-gray-300 outline-none appearance-none">
                                {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                            </select>
                            <button type="submit" className="bg-emerald-600 dark:bg-emerald-700 text-white px-6 py-4 rounded-2xl font-black active:scale-90 shadow-md"><i className="fas fa-plus"></i></button>
                        </div>
                    </form>
                    {items.length > 0 && (
                        <button onClick={share} className="w-full bg-green-500 dark:bg-green-600 text-white p-4 rounded-2xl font-black flex items-center justify-center gap-3 active:scale-95 shadow-lg uppercase text-xs tracking-widest">
                            <i className="fab fa-whatsapp text-lg"></i> Enviar Lista
                        </button>
                    )}
                    <div className="space-y-5">
                        {items.length === 0 ? <div className="text-center py-20 opacity-30 flex flex-col items-center gap-4"><i className="fas fa-check-double text-5xl"></i><p className="font-black">Lista vazia!</p></div> : 
                            categories.map(c => {
                                const group = items.filter(i => i.categoryId === c.id);
                                if (!group.length) return null;
                                return (
                                    <div key={c.id} className="space-y-2">
                                        <h3 className={`inline-block px-3 py-1 rounded-full text-white text-[10px] font-black uppercase tracking-[0.2em] shadow-sm ${getCatColor(c.color)}`}>{c.name}</h3>
                                        <div className="grid gap-3">
                                            {group.map(item => (
                                                <div key={item.id} className="bg-white dark:bg-darkSurface p-4 rounded-2xl flex items-center justify-between border border-gray-50 dark:border-gray-800 shadow-sm active:bg-gray-50 dark:active:bg-darkBg transition-all">
                                                    <div className="flex items-center gap-4 flex-1" onClick={() => onToggle(item.id)}>
                                                        <div className={`w-2 h-10 rounded-full ${getCatColor(c.color)}`}></div>
                                                        <span className="font-bold text-lg dark:text-gray-100">{item.name}</span>
                                                    </div>
                                                    <div className="flex gap-1">
                                                        <button onClick={() => onToggle(item.id)} className="w-12 h-12 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 rounded-xl active:scale-90 transition-all"><i className="fas fa-cart-plus text-lg"></i></button>
                                                        <button onClick={() => onRemove(item.id)} className="w-10 h-10 text-gray-300 dark:text-gray-700"><i className="fas fa-trash-alt"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                );
                            })
                        }
                    </div>
                </div>
            );
        };

        const CartView = ({ items, categories, onToggle, onUpdate, onFinalize }) => {
            const total = useMemo(() => items.reduce((s, i) => s + (i.price * i.quantity), 0), [items]);
            const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

            if (!items.length) return (
                <div className="text-center py-24 opacity-30 flex flex-col items-center gap-4">
                    <div className="w-24 h-24 bg-gray-100 dark:bg-darkSurface rounded-full flex items-center justify-center border-4 border-dashed border-gray-200 dark:border-gray-800">
                        <i className="fas fa-shopping-basket text-4xl"></i>
                    </div>
                    <p className="font-black text-xl tracking-tight">Carrinho Vazio</p>
                </div>
            );

            return (
                <div className="space-y-4 animate-fadeIn safe-bottom">
                    <div className="flex justify-between items-end px-1 mb-2">
                        <div>
                            <h2 className="text-2xl font-black tracking-tighter dark:text-white uppercase">Carrinho</h2>
                            <p className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Calculando pre√ßos</p>
                        </div>
                        <span className="bg-emerald-600 text-white px-3 py-1 rounded-xl text-[10px] font-black shadow-lg">
                            {items.length} {items.length === 1 ? 'ITEM' : 'ITENS'}
                        </span>
                    </div>

                    <div className="grid gap-3">
                        {items.map(item => {
                            const cat = categories.find(c => c.id === item.categoryId);
                            return (
                                <div key={item.id} className="bg-white dark:bg-darkSurface p-4 rounded-3xl shadow-sm border border-gray-50 dark:border-gray-800 space-y-4">
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-3 h-3 rounded-full ${cat?.color || 'bg-gray-400'}`}></div>
                                            <span className="font-black text-lg dark:text-white leading-tight">{item.name}</span>
                                        </div>
                                        <button onClick={() => onToggle(item.id)} className="w-8 h-8 text-gray-300"><i className="fas fa-times"></i></button>
                                    </div>
                                    <div className="grid grid-cols-12 gap-3 items-end">
                                        <div className="col-span-5">
                                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1 ml-1">Pre√ßo Un.</label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-emerald-600 font-black text-xs">R$</span>
                                                <input type="number" step="0.01" value={item.price || ''} onChange={e => onUpdate(item.id, { price: parseFloat(e.target.value) || 0 })} className="w-full bg-gray-50 dark:bg-darkBg p-3 pl-8 rounded-2xl font-black outline-none dark:text-white text-sm" placeholder="0,00" />
                                            </div>
                                        </div>
                                        <div className="col-span-4">
                                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1 ml-1">Qtd.</label>
                                            <div className="flex items-center bg-gray-50 dark:bg-darkBg rounded-2xl p-1">
                                                <button onClick={() => onUpdate(item.id, { quantity: Math.max(1, item.quantity - 1) })} className="w-7 h-7 font-black text-gray-400">-</button>
                                                <span className="flex-1 text-center font-black text-xs dark:text-white">{item.quantity}</span>
                                                <button onClick={() => onUpdate(item.id, { quantity: item.quantity + 1 })} className="w-7 h-7 font-black text-emerald-600">+</button>
                                            </div>
                                        </div>
                                        <div className="col-span-3 text-right">
                                            <label className="text-[9px] font-black text-gray-400 uppercase block mb-1">Subtotal</label>
                                            <span className="font-black text-emerald-600 text-[11px] block py-2 bg-emerald-50 dark:bg-emerald-900/10 rounded-xl text-center shadow-inner">{fmt(item.price * item.quantity)}</span>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Footer Compacto e Rebaixado conforme solicitado */}
                    <div className="fixed bottom-20 left-0 right-0 max-w-md mx-auto px-4 z-40 transition-all duration-300">
                        <div className="bg-emerald-700 dark:bg-emerald-800 text-white p-4 rounded-[2.2rem] shadow-2xl border-t border-emerald-500/30 backdrop-blur-md">
                            <div className="flex justify-between items-center mb-3 px-3">
                                <div>
                                    <span className="text-[8px] uppercase font-black opacity-50 tracking-widest block">Total estimado</span>
                                    <div className="text-3xl font-black tracking-tighter tabular-nums leading-none">{fmt(total)}</div>
                                </div>
                                <div className="w-10 h-10 bg-white/10 rounded-2xl flex items-center justify-center border border-white/5">
                                    <i className="fas fa-shopping-cart text-lg opacity-40"></i>
                                </div>
                            </div>
                            <button onClick={() => onFinalize(total)} className="w-full bg-white dark:bg-emerald-400 text-emerald-700 dark:text-emerald-950 p-4 rounded-2xl font-black uppercase tracking-widest active:scale-[0.97] transition-all text-xs shadow-xl flex items-center justify-center gap-2">
                                FINALIZAR COMPRA <i className="fas fa-check-circle text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const CategoryView = ({ categories, onAdd, onRemove, onExport, onImport }) => {
            const [name, setName] = useState('');
            const [color, setColor] = useState(COLOR_OPTIONS[0]);
            const fileRef = useRef(null);
            return (
                <div className="space-y-8 animate-fadeIn pb-24">
                    <div className="space-y-4">
                        <h2 className="text-xl font-black flex items-center gap-2 dark:text-white uppercase tracking-tighter"><i className="fas fa-save text-emerald-600"></i> Backup</h2>
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={onExport} className="bg-white dark:bg-darkSurface p-4 rounded-3xl border border-gray-100 dark:border-gray-800 flex flex-col items-center gap-2 active:scale-95 shadow-sm">
                                <div className="w-10 h-10 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-2xl flex items-center justify-center"><i className="fas fa-file-export"></i></div>
                                <span className="text-[10px] font-black uppercase tracking-widest dark:text-gray-400">Exportar</span>
                            </button>
                            <button onClick={() => fileRef.current.click()} className="bg-white dark:bg-darkSurface p-4 rounded-3xl border border-gray-100 dark:border-gray-800 flex flex-col items-center gap-2 active:scale-95 shadow-sm">
                                <div className="w-10 h-10 bg-amber-50 dark:bg-amber-900/20 text-amber-600 rounded-2xl flex items-center justify-center"><i className="fas fa-file-import"></i></div>
                                <span className="text-[10px] font-black uppercase tracking-widest dark:text-gray-400">Importar</span>
                            </button>
                            <input type="file" ref={fileRef} onChange={onImport} accept=".json" className="hidden" />
                        </div>
                    </div>
                    <div className="space-y-4">
                        <h2 className="text-xl font-black flex items-center gap-2 dark:text-white uppercase tracking-tighter"><i className="fas fa-tags text-emerald-600"></i> Categorias</h2>
                        <form onSubmit={e => { e.preventDefault(); if(name.trim()){ onAdd({ id: Date.now().toString(), name: name.trim(), color }); setName(''); } }} className="bg-white dark:bg-darkSurface p-5 rounded-3xl border border-gray-100 dark:border-gray-800 space-y-4 shadow-lg">
                            <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="Ex: Higiene" className="w-full p-4 bg-gray-50 dark:bg-darkBg rounded-2xl font-bold outline-none dark:text-white text-lg" />
                            <div className="flex flex-wrap gap-2 px-1">
                                {COLOR_OPTIONS.map(c => <button key={c} type="button" onClick={() => setColor(c)} className={`w-8 h-8 rounded-full ${c} ${color === c ? 'ring-4 ring-offset-2 ring-emerald-500 scale-110' : 'opacity-40 shadow-inner'}`}></button>)}
                            </div>
                            <button type="submit" className="w-full bg-emerald-600 text-white p-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-md">Adicionar Categoria</button>
                        </form>
                        <div className="grid gap-2">
                            {categories.map(c => (
                                <div key={c.id} className="bg-white dark:bg-darkSurface p-4 rounded-2xl flex items-center justify-between border border-gray-100 dark:border-gray-800 shadow-sm">
                                    <div className="flex items-center gap-3"><div className={`w-6 h-6 rounded-lg ${c.color}`}></div><span className="font-bold text-lg dark:text-white">{c.name}</span></div>
                                    {categories.length > 1 && <button onClick={() => onRemove(c.id)} className="text-gray-300 hover:text-red-500"><i className="fas fa-times-circle text-lg"></i></button>}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const HistoryView = ({ history }) => (
            <div className="space-y-4 animate-fadeIn pb-24">
                <h2 className="text-xl font-black flex items-center gap-2 dark:text-white uppercase tracking-tighter"><i className="fas fa-history text-emerald-600"></i> √öltimas Compras</h2>
                {!history.length ? <div className="text-center py-20 opacity-30 flex flex-col items-center gap-4"><i className="fas fa-receipt text-5xl"></i><p className="font-bold">Sem registros</p></div> : 
                    <div className="grid gap-3">
                        {history.map(h => (
                            <div key={h.id} className="bg-white dark:bg-darkSurface p-5 rounded-2xl border border-gray-100 dark:border-gray-800 flex justify-between items-center shadow-sm">
                                <div><p className="text-[10px] font-black text-gray-400 uppercase">{h.date}</p><p className="font-bold text-lg dark:text-gray-300">{h.itemCount} itens</p></div>
                                <div className="text-2xl font-black text-emerald-600">{new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(h.total)}</div>
                            </div>
                        ))}
                    </div>
                }
            </div>
        );

        // --- APP PRINCIPAL ---

        const App = () => {
            const [view, setView] = useState('LIST');
            const [theme, setTheme] = useState(() => localStorage.getItem('sl_theme') || 'light');
            const [categories, setCategories] = useState(() => JSON.parse(localStorage.getItem('sl_categories')) || DEFAULT_CATEGORIES);
            const [items, setItems] = useState(() => JSON.parse(localStorage.getItem('sl_items')) || []);
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('sl_history')) || []);
            const [impData, setImpData] = useState(null);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const imp = params.get('import');
                if (imp) {
                    try {
                        const news = imp.split(',').map(p => {
                            const [n, c] = p.split(':');
                            return { id: `m-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`, name: decodeURIComponent(n), categoryId: c || '5', inCart: false, price: 0, quantity: 1 };
                        });
                        setItems(prev => {
                            const names = new Set(prev.map(i => i.name.toLowerCase()));
                            return [...prev, ...news.filter(i => !names.has(i.name.toLowerCase()))];
                        });
                        window.history.replaceState({}, '', window.location.pathname);
                        alert('Itens adicionados!');
                    } catch (e) { console.error(e); }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('sl_theme', theme);
                document.documentElement.classList.toggle('dark', theme === 'dark');
            }, [theme]);

            useEffect(() => localStorage.setItem('sl_categories', JSON.stringify(categories)), [categories]);
            useEffect(() => localStorage.setItem('sl_items', JSON.stringify(items)), [items]);
            useEffect(() => localStorage.setItem('sl_history', JSON.stringify(history)), [history]);

            const addItem = (n, c) => setItems(prev => [...prev, { id: Date.now().toString(), name: n, categoryId: c, inCart: false, price: 0, quantity: 1 }]);
            const toggle = (id) => setItems(prev => prev.map(i => i.id === id ? { ...i, inCart: !i.inCart } : i));
            const update = (id, upd) => setItems(prev => prev.map(i => i.id === id ? { ...i, ...upd } : i));
            const finish = (t) => {
                const bought = items.filter(i => i.inCart);
                const record = { id: Date.now().toString(), date: new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }), total: t, itemCount: bought.length };
                setHistory(prev => [record, ...prev]);
                setItems(prev => prev.filter(i => !i.inCart));
                setView('HISTORY');
            };

            const exportBkp = () => {
                const data = { categories, items: items.filter(i => !i.inCart), exportedAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `MArket-backup.json`;
                a.click();
            };

            const handleImp = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const r = new FileReader();
                r.onload = (ev) => {
                    const data = JSON.parse(ev.target.result);
                    if (data.categories && data.items) setImpData(data);
                    else alert('Backup inv√°lido');
                };
                r.readAsText(file);
                e.target.value = '';
            };

            const confirmImp = (rep) => {
                if (rep) { setCategories(impData.categories); setItems(impData.items); }
                else {
                    setCategories(prev => {
                        const ids = new Set(prev.map(c => c.id));
                        return [...prev, ...impData.categories.filter(c => !ids.has(c.id))];
                    });
                    setItems(prev => [...prev, ...impData.items.map(i => ({...i, id: `bkp-${Date.now()}-${Math.random()}`}))]);
                }
                setImpData(null);
                alert('Pronto!');
            };

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-darkBg max-w-md mx-auto shadow-2xl relative transition-colors duration-300">
                    <Header theme={theme} onToggleTheme={() => setTheme(t => t === 'light' ? 'dark' : 'light')} />
                    <main className="flex-1 overflow-y-auto px-4 py-6 custom-scroll">
                        {view === 'LIST' && <ShoppingListView items={items.filter(i => !i.inCart)} categories={categories} onToggle={toggle} onAdd={addItem} onRemove={(id) => setItems(it => it.filter(i => i.id !== id))} getImportLink={() => {
                            const missing = items.filter(i => !i.inCart);
                            if (!missing.length) return null;
                            const d = missing.map(i => `${encodeURIComponent(i.name)}:${i.categoryId}`).join(',');
                            return `${window.location.origin}${window.location.pathname}?import=${d}`;
                        }} />}
                        {view === 'CART' && <CartView items={items.filter(i => i.inCart)} categories={categories} onToggle={toggle} onUpdate={update} onFinalize={finish} />}
                        {view === 'HISTORY' && <HistoryView history={history} />}
                        {view === 'CATEGORIES' && <CategoryView categories={categories} onAdd={c => setCategories(p => [...p, c])} onRemove={id => setCategories(p => p.filter(c => c.id !== id))} onExport={exportBkp} onImport={handleImp} />}
                    </main>
                    <Navigation currentView={view} setView={setView} cartCount={items.filter(i => i.inCart).length} />
                    
                    {impData && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/70 backdrop-blur-sm animate-fadeIn px-6">
                            <div className="bg-white dark:bg-darkSurface w-full rounded-[2.5rem] p-8 space-y-6 shadow-2xl">
                                <div className="text-center space-y-2">
                                    <div className="w-16 h-16 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-full flex items-center justify-center mx-auto mb-4"><i className="fas fa-file-import text-2xl"></i></div>
                                    <h3 className="text-2xl font-black dark:text-white uppercase tracking-tighter">Backup</h3>
                                    <p className="text-gray-500 text-sm font-medium">Como deseja importar os dados?</p>
                                </div>
                                <div className="grid gap-3">
                                    <button onClick={() => confirmImp(false)} className="p-4 bg-emerald-600 text-white rounded-2xl font-black uppercase text-xs tracking-widest active:scale-95 transition-all">Adicionar √† lista</button>
                                    <button onClick={() => confirmImp(true)} className="p-4 bg-white dark:bg-darkBg border-2 border-emerald-600 text-emerald-600 dark:text-emerald-400 rounded-2xl font-black uppercase text-xs tracking-widest active:scale-95 transition-all">Substituir tudo</button>
                                    <button onClick={() => setImpData(null)} className="text-gray-400 font-bold text-xs uppercase pt-2 tracking-widest">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
